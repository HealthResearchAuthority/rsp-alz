# Reusable stage template for cross-subscription deployment

parameters:
  - name: environmentName
    type: string
  - name: displayName
    type: string
  - name: deployDwPrivateEndpoints
    type: boolean
  - name: selectedEnvironment
    type: string

stages:
  - stage: ${{ parameters.environmentName }}
    displayName: ${{ parameters.displayName }}
    dependsOn: []
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), eq('${{ parameters.selectedEnvironment }}', '${{ parameters.environmentName }}'))
    variables:
      - group: CrossSubscription-${{ parameters.environmentName }}
    jobs:
      - job: setup
        displayName: 'Checkout and Install Bicep'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
          - bash: |
              az bicep install
              az bicep version
            displayName: 'Install Bicep CLI'

      - job: FinalWhatIf
        displayName: 'Run What-If before Deployment'
        pool:
          vmImage: 'ubuntu-latest'
        dependsOn: [setup]
        steps:
          - task: AzureCLI@2
            displayName: 'Final What-If'
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az config set bicep.use_binary_from_path=false --only-show-errors
                az deployment mg what-if \
                  --location $(location) \
                  --template-file ./6.cross-subscription/main.bicep \
                  --management-group-id $(management-group-id) \
                  --parameters ./6.cross-subscription/main.parameters.bicepparam \
                              paramvnetPeeringsVNetIDs=$(paramvnetPeeringsVNetIDs) \
                              manageddevopspoolVnetID=$(manageddevopspoolVnetID) \
                              paramserviceIds=$(paramserviceIds) \
                              environment='${{ parameters.environmentName }}' \
                              storageSubscriptionId="$(storageSubscriptionId)" \
                              devboxSubscriptionId="$(devboxSubscriptionId)" \
                              deployDwPrivateEndpoints=${{ parameters.deployDwPrivateEndpoints }} \
                              dwFunctionAppId=$(dwFunctionAppId) \
                              dwFunctionAppSubscriptionId="$(dwFunctionAppSubscriptionId)" \
                              dwNetworkingResourceGroup="$(dwNetworkingResourceGroup)" \
                              dwVnetName="$(dwVnetName)" \
                              dwPrivateEndpointSubnetName="$(dwPrivateEndpointSubnetName)" \
                              dwEnvironment="$(dwEnvironment)" \
                              enableDevBoxSqlReplicaEndpoints=$(enableDevBoxSqlReplicaEndpoints) \
                              replicaSqlServerResourceIds="$(replicaSqlServerResourceIds)" \
                              replicaSqlServerNames="$(replicaSqlServerNames)" \
                              devBoxSecondaryVNetIds="$(devBoxSecondaryVNetIds)"

      - deployment: deploy
        displayName: 'Deploy Cross Subscription'
        pool:
          vmImage: 'ubuntu-latest'
        dependsOn: [setup, FinalWhatIf]
        condition: succeeded()
        environment: 'alz-bicep-deployment'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - bash: |
                    az bicep install
                    az bicep version
                  displayName: 'Install Bicep CLI'
                - task: AzureCLI@2
                  displayName: 'Deploy Cross Subscription'
                  name: deploy
                  inputs:
                    azureSubscription: $(azureServiceConnection)
                    scriptType: bash
                    scriptLocation: inlineScript
                    failOnStandardError: true
                    inlineScript: |
                      az config set bicep.use_binary_from_path=false --only-show-errors
                      output=$(az deployment mg create \
                        --name "cross-subscription-$(Build.BuildId)" \
                        --location $(location) \
                        --management-group-id $(management-group-id) \
                        --template-file ./6.cross-subscription/main.bicep \
                        --parameters ./6.cross-subscription/main.parameters.bicepparam \
                                    paramvnetPeeringsVNetIDs=$(paramvnetPeeringsVNetIDs) \
                                    manageddevopspoolVnetID=$(manageddevopspoolVnetID) \
                                    paramserviceIds=$(paramserviceIds) \
                                    environment='${{ parameters.environmentName }}' \
                                    storageSubscriptionId="$(storageSubscriptionId)" \
                                    devboxSubscriptionId="$(devboxSubscriptionId)" \
                                    deployDwPrivateEndpoints=${{ parameters.deployDwPrivateEndpoints }} \
                                    dwFunctionAppId=$(dwFunctionAppId) \
                                    dwFunctionAppSubscriptionId="$(dwFunctionAppSubscriptionId)" \
                                    dwNetworkingResourceGroup="$(dwNetworkingResourceGroup)" \
                                    dwVnetName="$(dwVnetName)" \
                                    dwPrivateEndpointSubnetName="$(dwPrivateEndpointSubnetName)" \
                                    dwEnvironment="$(dwEnvironment)")
                      echo "Full Bicep Deployment Output:"
                      echo $output | jq .
