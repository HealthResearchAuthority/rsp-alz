# Reusable stage template for application deployment

parameters:
  - name: environmentName
    type: string
  - name: displayName
    type: string
  - name: createSecretsWithPlaceholders
    type: boolean
  - name: selectedEnvironment
    type: string

stages:
  - stage: ${{ parameters.environmentName }}
    displayName: ${{ parameters.displayName }}
    dependsOn: []
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), eq('${{ parameters.selectedEnvironment }}', '${{ parameters.environmentName }}'))
    jobs:
      - job: setup
        displayName: 'Get DevOps Public IP'
        variables:
          - group: ${{ parameters.environmentName }}
          - group: ${{ parameters.environmentName }}-keyvault
        pool:
          name: rsp-manageddevopspool
        steps:
          - bash: |
              echo "$(parWhitelistIPs)"
            name: parWhitelistIPs
            displayName: 'WhitelistIPs'
          - bash: |
              echo "$(clarityProjectId)"
            name: clarityProjectId
            displayName: 'Clarity Project ID'
          - bash: |
              echo "$(googleTagId)"
            name: googleTagId
            displayName: 'Google Tag ID'
          - bash: |
              echo "$(cmsUri)"
            name: cmsUri
            displayName: 'CMS URI'
          - bash: |
              echo "$(portalUrl)"
            name: portalUrl
            displayName: 'Portal URI'
          - bash: |
              ipaddress=$(curl -s http://ipinfo.io/ip)
              ipaddressipify=$(curl -s https://api.ipify.org)
              echo "##vso[task.setvariable variable=ipaddress;isOutput=true;]$ipaddress"
              echo "##vso[task.setvariable variable=ipaddressipify;isOutput=true;]$ipaddressipify"
            name: fetchPublicIP
            displayName: 'Fetch Public IP'

      - job: FinalWhatIf
        displayName: 'Run What-If before Deployment'
        dependsOn: [setup]
        condition: succeeded()
        pool:
          name: rsp-manageddevopspool
        variables:
          - name: devOpsPublicIP
            value: $[dependencies.setup.outputs['fetchPublicIP.ipaddress']]
          - group: ${{ parameters.environmentName }}
          - group: ${{ parameters.environmentName }}-keyvault
        steps:
          - checkout: self
          - script: |
              echo "Installing Azure CLI..."
              curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
            displayName: 'Install Azure CLI'
          - bash: |
              az bicep install
              az bicep version
            displayName: 'Install Bicep CLI'

          - task: AzureCLI@2
            displayName: 'Final What-If'
            inputs:
              azureSubscription: $(${{ parameters.environmentName }})
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az config set bicep.use_binary_from_path=false --only-show-errors
                az deployment sub what-if --location $(location) --template-file ./5.spoke-network/main.application.bicep \
                  --parameters ./5.spoke-network/app-parameters/${{ parameters.environmentName }}.parameters.bicepparam \
                              parAdminLogin=$(rspsqladminloginname) parSqlAdminPhrase=$(rspsqladminphrase) \
                              parClientID=$(clientID) parClientSecret=$(clientSecret) \
                              logAnalyticsWorkspaceId=$(logAnalyticsWorkspaceId) parDevOpsPublicIPAddress=$(devOpsPublicIP) \
                              paramWhitelistIPs=$(parWhitelistIPs) \
                              parClarityProjectId=$(clarityProjectId) \
                              parGoogleTagId=$(googleTagId) \
                              parCmsUri=$(cmsUri) \
                              parLogoutUrl=$(logoutUrl) \
                              parRtsApiBaseUrl=$(rtsApiBaseUrl) \
                              parRtsAuthApiBaseUrl=$(rtsAuthApiBaseUrl) \
                              parPortalUrl=$(portalUrl)
                              parCleanStorageAccountName=$(cleanStorageAccountName) \
                              parCleanStorageAccountKey=$(cleanStorageAccountKey) \
                              parStagingStorageAccountName=$(stagingStorageAccountName) \
                              parStagingStorageAccountKey=$(stagingStorageAccountKey) \
                              parQuarantineStorageAccountName=$(quarantineStorageAccountName) \
                              parQuarantineStorageAccountKey=$(quarantineStorageAccountKey) \
                              parMicrosoftEntraAuthority=$(parMicrosoftEntraAuthority) \
                              parMicrosoftEntraAudience=$(parMicrosoftEntraAudience) \
                              processDocuUploadManagedIdentityClientId=$(processDocuUploadManagedIdentityClientId) \
                              parValidateIrasIdClientId=$(parValidateIrasIdClientId) \
                              parValidateIrasIdAllowedAudiences=$(parValidateIrasIdAllowedAudiences) \
                              parCreateKVSecretsWithPlaceholders=${{ parameters.createSecretsWithPlaceholders }}

      - deployment: deploy
        displayName: 'Deploy Applications'
        pool:
          name: rsp-manageddevopspool
        dependsOn: [setup, FinalWhatIf]
        condition: succeeded()
        environment: ${{ parameters.environmentName }}
        variables:
          - name: devOpsPublicIP
            value: $[dependencies.setup.outputs['fetchPublicIP.ipaddress']]
          - name: devOpsIPIFYPublicIP
            value: $[dependencies.setup.outputs['fetchPublicIP.ipaddressipify']]
          - group: ${{ parameters.environmentName }}
          - group: ${{ parameters.environmentName }}-keyvault
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - script: |
                    echo "Installing Azure CLI..."
                    curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
                  displayName: 'Install Azure CLI'
                - bash: |
                    az bicep install
                    az bicep version
                  displayName: 'Install Bicep CLI'
                - bash: echo "Azure DevOps Public IP Address is $(devOpsPublicIP)"
                - bash: echo "Azure DevOps Public IP Address from IPIFY is $(devOpsIPIFYPublicIP)"

                - task: AzureCLI@2
                  name: deploy
                  displayName: 'Deploy Applications'
                  inputs:
                    azureSubscription: $(${{ parameters.environmentName }})
                    scriptType: bash
                    scriptLocation: inlineScript
                    failOnStandardError: true
                    inlineScript: |
                      az config set bicep.use_binary_from_path=false --only-show-errors
                      output=$(az stack sub create --name "application-deployment-stack" --location $(location) --template-file ./5.spoke-network/main.application.bicep  \
                        --parameters ./5.spoke-network/app-parameters/${{ parameters.environmentName }}.parameters.bicepparam \
                                    parAdminLogin=$(rspsqladminloginname) parSqlAdminPhrase=$(rspsqladminphrase) \
                                    parClientID=$(clientID) parClientSecret=$(clientSecret) \
                                    logAnalyticsWorkspaceId=$(logAnalyticsWorkspaceId) parDevOpsPublicIPAddress=$(devOpsPublicIP) \
                                    paramWhitelistIPs=$(parWhitelistIPs) \
                                    parClarityProjectId=$(clarityProjectId) \
                                    parGoogleTagId=$(googleTagId) \
                                    parCmsUri=$(cmsUri) \
                                    parLogoutUrl=$(logoutUrl) \
                                    parRtsApiBaseUrl=$(rtsApiBaseUrl) \
                                    parRtsAuthApiBaseUrl=$(rtsAuthApiBaseUrl) \
                                    parPortalUrl=$(portalUrl) \
                                    parCleanStorageAccountName=$(cleanStorageAccountName) \
                                    parCleanStorageAccountKey=$(cleanStorageAccountKey) \
                                    parStagingStorageAccountName=$(stagingStorageAccountName) \
                                    parStagingStorageAccountKey=$(stagingStorageAccountKey) \
                                    parQuarantineStorageAccountName=$(quarantineStorageAccountName) \
                                    parQuarantineStorageAccountKey=$(quarantineStorageAccountKey) \
                                    parMicrosoftEntraAuthority=$(parMicrosoftEntraAuthority) \
                                    parMicrosoftEntraAudience=$(parMicrosoftEntraAudience) \
                                    processDocuUploadManagedIdentityClientId=$(processDocuUploadManagedIdentityClientId) \
                                    parValidateIrasIdClientId=$(parValidateIrasIdClientId) \
                                    parValidateIrasIdAllowedAudiences=$(parValidateIrasIdAllowedAudiences) \
                                    parCreateKVSecretsWithPlaceholders=${{ parameters.createSecretsWithPlaceholders }} \
                                    --deny-settings-mode none --action-on-unmanage deleteResources --yes)
                      echo $output | jq .
                      appResourceGroup=$(echo $output | jq -r '.properties.outputs.appResourceGroupName.value')
                      echo "##vso[task.setvariable variable=appResourceGroupName;isoutput=true]$appResourceGroup"
